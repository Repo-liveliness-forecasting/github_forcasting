---
title: "Forcasting issues"
author: "Forcast Padawan 2"
date: "November 17, 2016"
output: pdf_document
---

The goal of this experiment is to design the best model to forcaste the number of issue in the per day in the comming two weeks. We think that this could help Open Source organisation to manage there human ressources.

# Load the data

```{r results='hide', message=FALSE, warning=FALSE}
#install.packages('forecast')
library('forecast')
library(knitr)
#load the data frame
issues.csv <- read.csv("issues/julialang_julia.csv")
commits.csv <- read.csv("commits/julialang_julia.csv")

issues.csv$date = as.POSIXlt(as.Date(issues.csv$date,format='%m/%d/%Y'))
commits.csv$date = as.POSIXlt(as.Date(commits.csv$date,format='%m/%d/%Y'))
```

keep the last 12 months

```{r}
to_date <- issues.csv$date[length(issues.csv$date)]
from_date <- to_date
from_date$year <- from_date$year - 1

issues.csv <- subset(issues.csv, date <= to_date & date >= from_date)
commits.csv <- subset(commits.csv, date <= to_date & date >= from_date)
```

```{r}
#loading issues and commits into a ts object
issues.ts <- ts(issues.csv$number_of_issues, frequency = 7) 

commits.ts <- ts(commits.csv$number_of_commits, frequency = 7) 
plot(issues.ts, main = 'Issues', bty = 'l', ylab = 'Number of Issues')
plot(commits.ts, main = 'Commits', bty = 'l', ylab = 'Number of Commits')
```

```{r}
time <- time(issues.ts)

n.sample <- 14
n.valid <- 21


separate.train.test <- function(timeserie, n.valid) {
  time <- time(timeserie)
  n.train <- length(timeserie) - n.valid
  results = list()
  results$train.ts <- window(timeserie, start=time[1], end=time[n.train])
  results$valid.ts <- window(timeserie, start=time[n.train+1], end=time[n.train+n.valid])
  return(results)
}

all.issues <- sapply(0:(n.sample - 1), function(i) return(separate.train.test(window(issues.ts,start=time[1],end=time[length(issues.ts)-i]), n.valid)))

issues  <- separate.train.test(issues.ts, n.valid)
commits  <- separate.train.test(commits.ts, n.valid)
```

# Naive Forecast

## Naive

```{r kable}
for(i in 1:n.sample) {
  issues <- all.issues[,i]
  train.issues.naive.pred <- naive(issues$train.ts, h=n.valid)
  kable(accuracy(train.issues.naive.pred, issues$valid.ts))
  hist(issues$valid.ts - train.issues.naive.pred$mean)
  plot(issues$valid.ts - train.issues.naive.pred$mean)
  plot(train.issues.naive.pred)
  lines(issues$valid.ts) 
}
```

## Seasonal Naive

```{r} 
train.issues.snaive.pred <- snaive(issues$train.ts, h=n.valid)
kable(accuracy(train.issues.snaive.pred, issues$valid.ts))
hist(issues$valid.ts - train.issues.snaive.pred$mean)
plot(issues$valid.ts - train.issues.snaive.pred$mean)
plot(train.issues.snaive.pred)
lines(issues$valid.ts)
```

# Smoothing

## Holt Winter

```{r}
train.issues.hw.pred <- hw(issues$train.ts, hw = "ZAA", h = n.valid)
kable(accuracy(train.issues.hw.pred, issues$valid.ts))
hist(issues$valid.ts - train.issues.hw.pred$mean)
plot(issues$valid.ts - train.issues.hw.pred$mean)
plot(train.issues.hw.pred)
lines(issues$valid.ts)
```

## Double differencing

```{r}
train.issues.d1 <- diff(issues$train.ts, lag = 1)
train.issues.d1.d7 <- diff(train.issues.d1, lag = 7)

ma.trailing <- rollmean(train.issues.d1.d7, k = 7, align = "right")
last.ma <- tail(ma.trailing, 1)
ma.trailing.pred <- ts(c(train.issues.d1.d7[1:6], ma.trailing, rep(last.ma, n.valid)), start=c(2,2), frequency = 7)

ma.dd.pred.d1 <- diffinv(ma.trailing.pred, lag = 7, xi=train.issues.d1[1:7])
ma.dd.pred <- diffinv(ma.dd.pred.d1, lag = 1, xi=issues$train.ts[1])

plot(ma.dd.pred,col='red')
lines(issues.ts,col='blue')
```

# Regression

## Linear additive regression

```{r}
train.issues.linear.regr.add.m <- tslm(issues$train.ts ~ trend + season)
train.issues.linear.regr.add.m
train.issues.linear.regr.add.pred <- forecast(train.issues.linear.regr.add.m , h=n.valid)

kable(accuracy(train.issues.linear.regr.add.pred, issues$valid.ts))
hist(issues$valid.ts - train.issues.linear.regr.add.pred$mean)
plot(issues$valid.ts - train.issues.linear.regr.add.pred$mean)
plot(train.issues.linear.regr.add.pred)
lines(issues$valid.ts)
```

## linear multiplicative regression

```{r}
train.issues.linear.regr.mult.m <- tslm(issues$train.ts ~ trend + season, lambda = 0)
train.issues.linear.regr.mult.m
train.issues.linear.regr.mult.pred <- forecast(train.issues.linear.regr.mult.m , h=n.valid)

kable(accuracy(train.issues.linear.regr.mult.pred, issues$valid.ts))
hist(issues$valid.ts - train.issues.linear.regr.mult.pred$mean)
plot(issues$valid.ts - train.issues.linear.regr.mult.pred$mean)
plot(train.issues.linear.regr.mult.pred)
lines(issues$valid.ts)
```

# external regression


```{r}
plot(issues.ts, col='blue')
lines(commits.ts, col='green')

train.commits.d1 <- diff(commits$train.ts, lag = 1)
train.commits.d1.d7 <- diff(train.commits.d1, lag = 7)

plot(train.issues.d1.d7, col='blue')
lines(lag(train.commits.d1.d7,2), col='green')

```

```{r}
train.issues.arima.ext.m <- Arima(issues$train.ts, order=c(1,0,0), seasonal=c(1,0,0), xreg=commits$train.ts )
train.issues.arima.ext.m
```



