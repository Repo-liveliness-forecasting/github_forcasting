---
title: "Forcasting issues"
author: "Forcast Padawan 2"
date: "November 17, 2016"
output: pdf_document
---

The goal of this experiment is to design the best model to forcaste the number of issue in the per day in the comming two weeks. We think that sthis could help Open Source organisation to manage there human ressources.

# Load the data

```{r results='hide', message=FALSE, warning=FALSE}
#install.packages('forecast')
library('forecast')
library(knitr)
#load the data frame
issues.csv <- read.csv("issues/julialang_julia.csv")
commits.csv <- read.csv("commits/julialang_julia.csv")

issues.csv$date = as.POSIXlt(as.Date(issues.csv$date,format='%m/%d/%Y'))
commits.csv$date = as.POSIXlt(as.Date(commits.csv$date,format='%m/%d/%Y'))
```

keep the last 12 months

```{r}
to_date <- issues.csv$date[length(issues.csv$date)]
from_date <- to_date
from_date$year <- from_date$year - 1

issues.csv <- subset(issues.csv, date <= to_date & date >= from_date)
commits.csv <- subset(commits.csv, date <= to_date & date >= from_date)
```

```{r}
#loading issues and commits into a ts object
issues.ts <- ts(issues.csv$number_of_issues, frequency = 7) 

commits.ts <- ts(commits.csv$number_of_commits, frequency = 7) 
plot(issues.ts, main = 'Issues', bty = 'l', ylab = 'Number of Issues')
plot(commits.ts, main = 'Commits', bty = 'l', ylab = 'Number of Commits')
```

```{r}
time <- time(issues.ts)

n.valid <- 21
n.train <- length(issues.ts) - n.valid

train.issues.ts <- window(issues.ts, start=time[1], end=time[n.train])
valid.issues.ts <- window(issues.ts, 
                    start=time[n.train+1], 
                    end=time[n.train+n.valid])

train.commits.ts <- window(commits.ts, start=time[1], end=time[n.train])
valid.commits.ts <- window(commits.ts, 
                      start=time[n.train+1], 
                      end=time[n.train+n.valid])
```

# Naive Forecast

## Naive

```{r kable}
train.issues.naive.pred <- naive(train.issues.ts, h=n.valid)
kable(accuracy(train.issues.naive.pred, valid.issues.ts))
hist(valid.issues.ts - train.issues.naive.pred$mean)
plot(valid.issues.ts - train.issues.naive.pred$mean)
plot(train.issues.naive.pred)
lines(valid.issues.ts)
```

## Seasonal Naive

```{r} 
train.issues.snaive.pred <- snaive(train.issues.ts, h=n.valid)
kable(accuracy(train.issues.snaive.pred, valid.issues.ts))
hist(valid.issues.ts - train.issues.snaive.pred$mean)
plot(valid.issues.ts - train.issues.snaive.pred$mean)
plot(train.issues.snaive.pred)
lines(valid.issues.ts)
```

# Smoothing

## Deseasonalize series

```{r}
diff7 = diff(issues.ts, lag = 7)
nValid.ma = 21
nTrain.ma = length(diff7) - nValid.ma
time.diff = time(diff7)
train.ts.ma = window(diff7, start = time.diff[1], end = time.diff[nTrain.ma])
valid.ts.ma = window(diff7, start = time.diff[nTrain.ma + 1],
                     end = time.diff[nTrain.ma + nValid.ma])
                     

plot(diff7, ylab = 'Lag-7', main = 'Deseasonalized series (Spark)', bty = 'l')
```

## Moving Average

```{r}
library(zoo)
ma.trailing = rollmean(train.ts.ma, k = 7, align = 'right')

undiff = rep(0, length(ma.trailing))
for(j in 1:length(ma.trailing)){
  undiff[j] = ma.trailing[j] + issues.ts[j + 6]
}
undiff.ts = ts(undiff, start = time.diff[1], freq = 7)

plot(issues.ts, main = 'Spark (Moving Average)', bty = 'l', ylab = 'Number of Issues')
lines(undiff.ts, lwd = 2, col = 'blue')

last.ma = tail(undiff.ts, 1)
undiff.ts.pred = ts(rep(last.ma, 21), start = time.diff[nTrain.ma + 1], freq = 7)
lines(undiff.ts.pred, lwd = 2, lty = 2, col = 'orange')

plot(train.issues.ts[14:346] - undiff.ts, main = 'Moving Average Forecast Errors',
     ylab = 'Errors', xlab = 'Week', xlim = c(0, 54), bty = 'l')
lines(valid.issues.ts - undiff.ts.pred, lwd = 2, col = 'blue')

rmse = function(act, est) { return(sqrt(mean((act - est) ^ 2))) }
rmse(act = train.issues.ts[14:346], est = undiff.ts)
rmse(act = valid.issues.ts, est = undiff.ts.pred)

mape = function(act, est) { return(mean(abs(act - est) / act * 100)) }
mape(act = train.issues.ts[14:346], est = undiff.ts)
mape(act = valid.issues.ts, est = undiff.ts.pred)
```

## Exponential Smoothing

```{r}
ets = ets(train.issues.ts, model = 'ZZZ', restrict = FALSE, allow.multiplicative.trend = TRUE)
summary(ets)
ets.pred = forecast(ets, h = n.valid, level = 0)

plot(ets.pred, main = 'Spark (Exponential Smoothing MNM)', bty = 'l', ylab = 'Number of Issues')
lines(ets.pred$fitted, lwd = 2, col = 'blue')
lines(valid.issues.ts)

plot(train.issues.ts - ets.pred$fitted, main = 'Exponential Smoothing (MNM) Errors Plot',
     bty = 'l', xlab = 'Week', ylab = 'Errors', xlim = c(0, 54))
lines(valid.issues.ts - ets.pred$mean, lwd = 2, col = 'blue')
kable(accuracy(ets.pred, valid.issues.ts))
```

## Holt Winter

```{r}
train.issues.hw.pred <- hw(train.issues.ts, hw = "ZAA", h = n.valid)
kable(accuracy(train.issues.hw.pred, valid.issues.ts))
hist(valid.issues.ts - train.issues.hw.pred$mean)
plot(valid.issues.ts - train.issues.hw.pred$mean)
plot(train.issues.hw.pred)
lines(valid.issues.ts)
```

## Double differencing

```{r}
train.issues.d1 <- diff(train.issues.ts, lag = 1)
train.issues.d1.d7 <- diff(train.issues.d1, lag = 7)

ma.trailing <- rollmean(train.issues.d1.d7, k = 7, align = "right")
last.ma <- tail(ma.trailing, 1)
ma.trailing.pred <- ts(c(train.issues.d1.d7[1:6], ma.trailing, rep(last.ma, n.valid)), start=c(2,2), frequency = 7)

ma.dd.pred.d1 <- diffinv(ma.trailing.pred, lag = 7, xi=train.issues.d1[1:7])
ma.dd.pred <- diffinv(ma.dd.pred.d1, lag = 1, xi=train.issues.ts[1])

kable(accuracy(ma.dd.pred[(n.train+1):(n.train+n.valid)], valid.issues.ts))
hist(valid.issues.ts - ma.dd.pred[(n.train+1):(n.train+n.valid)])
plot(valid.issues.ts - ma.dd.pred[(n.train+1):(n.train+n.valid)])
plot(ma.dd.pred,col='red')
lines(issues.ts,col='blue')
```

# Regression

## Linear additive regression

```{r}
train.issues.linear.regr.add.m <- tslm(train.issues.ts ~ trend + season)
train.issues.linear.regr.add.m
train.issues.linear.regr.add.pred <- forecast(train.issues.linear.regr.add.m , h=n.valid)

kable(accuracy(train.issues.linear.regr.add.pred, valid.issues.ts))
hist(valid.issues.ts - train.issues.linear.regr.add.pred$mean)
plot(valid.issues.ts - train.issues.linear.regr.add.pred$mean)
plot(train.issues.linear.regr.add.pred)
lines(valid.issues.ts)
```

## linear multiplicative regression

```{r}
train.issues.linear.regr.mult.m <- tslm(train.issues.ts ~ trend + season, lambda = 0)
train.issues.linear.regr.mult.m
train.issues.linear.regr.mult.pred <- forecast(train.issues.linear.regr.mult.m , h=n.valid)

kable(accuracy(train.issues.linear.regr.mult.pred, valid.issues.ts))
hist(valid.issues.ts - train.issues.linear.regr.mult.pred$mean)
plot(valid.issues.ts - train.issues.linear.regr.mult.pred$mean)
plot(train.issues.linear.regr.mult.pred)
lines(valid.issues.ts)
```

## linear additive seasonality

```{r}
train.issues.lm.additive.seasonality = tslm(train.issues.ts ~ season)
train.issues.lm.additive.seasonality.pred = forecast(train.issues.lm.additive.seasonality,
                                                     h = n.valid, level = 0)
plot(train.issues.lm.additive.seasonality.pred,
     main = 'Spark (Linear Regression Additive Seasonality)', bty = 'l',
     ylab = 'Number of Issues')
lines(train.issues.lm.additive.seasonality.pred$fitted, lwd = 2, col = 'blue')
lines(valid.issues.ts)

plot(train.issues.ts - train.issues.lm.additive.seasonality.pred$fitted,
     main = 'Linear Regression Additive Seasonality Errors Plot', bty = 'l', xlab = 'Week',
     ylab = 'Errors', xlim = c(0, 54))
lines(valid.issues.ts - train.issues.lm.additive.seasonality.pred$mean, lwd = 2, col = 'blue')
kable(accuracy(train.issues.lm.additive.seasonality.pred, valid.issues.ts))
summary(train.issues.lm.additive.seasonality)
```

## linear multiplicative seasonality

```{r}
train.issues.lm.multiplicative.seasonality = tslm(train.issues.ts ~ season, lambda = 0)
train.issues.lm.multiplicative.seasonality.pred = forecast(
  train.issues.lm.multiplicative.seasonality, h = n.valid, level = 0)
plot(train.issues.lm.multiplicative.seasonality.pred,
     main = 'Spark (Linear Regression Multiplicative Seasonality)', bty = 'l',
     ylab = 'Number of Issues')
lines(train.issues.lm.multiplicative.seasonality.pred$fitted, lwd = 2, col = 'blue')
lines(valid.issues.ts)

plot(train.issues.ts - train.issues.lm.multiplicative.seasonality.pred$fitted,
     main = 'Linear Regression Multiplicative Seasonality Errors Plot', bty = 'l', xlab = 'Week',
     ylab = 'Errors', xlim = c(0, 54))
lines(valid.issues.ts - train.issues.lm.multiplicative.seasonality.pred$mean, lwd = 2,
      col = 'blue')
kable(accuracy(train.issues.lm.multiplicative.seasonality.pred, valid.issues.ts))
summary(train.issues.lm.multiplicative.seasonality)
```

# Choose one best model, and do autocorrelation on it

```{r}
Acf(train.issues.ts - ets.pred$fitted, lag.max = 7,
    main = 'Autocorrelation on exponential smoothing residual series')
```

# AR(7) model from residual residual series

```{r}
train.res.arima = Arima(train.issues.ts - ets.pred$fitted, order = c(7, 0, 0))
train.res.arima.pred = forecast(train.res.arima, h = n.valid, level = 0)

plot(train.res.arima.pred, ylab = 'Residuals', xlab = 'Week', bty = 'l', flty = 2, main = '')
lines(train.res.arima.pred$fitted, lwd = 2, col = 'blue')
lines(valid.issues.ts - ets.pred$mean)

plot(issues.ts, main = 'Spark (AR(7))', bty = 'l', ylab = 'Number of Issues', xlim = c(0, 54))
lines(ets.pred$fitted + train.res.arima.pred$fitted, lwd = 2, col = 'blue')
lines(ets.pred$mean + train.res.arima.pred$mean, lwd = 2, lty = 2, col = 'blue')

plot(train.issues.ts - (ets.pred$fitted + train.res.arima.pred$fitted), xlim = c(0, 54),
     main = 'AR(7) Forecast Errors Plot', bty = 'l', ylab = 'Errors')
lines(valid.issues.ts - (ets.pred$mean + train.res.arima.pred$mean), col = 'blue', lwd = 2)

rmse(act = train.issues.ts,
     est = ets.pred$fitted + train.res.arima.pred$fitted)
rmse(act = valid.issues.ts, est = ets.pred$mean + train.res.arima.pred$mean)

mape(act = train.issues.ts,
     est = ets.pred$fitted + train.res.arima.pred$fitted)
mape(act = valid.issues.ts, est = ets.pred$mean + train.res.arima.pred$mean)

Acf(train.issues.ts - (ets.pred$fitted + train.res.arima.pred$fitted), lag.max = 7,
    main = 'Autocorrelations of residuals-of-residuals series')
```

# external info

```{r}
xTrain = data.frame(isCommit = issues.csv$is_commit[1:n.train])
xTest = data.frame(isCommit = issues.csv$is_commit[(n.train + 1):(n.train + n.valid)])
stlm.reg.fit = stlm(train.issues.ts, s.window = 'periodic', xreg = xTrain, method = 'arima')
stlm.reg.fit$model
stlm.reg.pred = forecast(stlm.reg.fit, xreg = xTest, h = n.valid, level = 0)

plot(stlm.reg.pred, ylab = 'Number of Issues', xlab = 'Week', bty = 'l')
lines(stlm.reg.pred$fitted, col = 'blue', lwd = 2)
lines(valid.issues.ts)

plot(train.issues.ts - stlm.reg.pred$fitted, main = 'External Info Errors Plot', bty = 'l',
     ylab = 'Errors', xlab = 'Week', xlim = c(0, 54))
lines(valid.issues.ts - stlm.reg.pred$mean, col = 'blue', lwd = 2)
kable(accuracy(stlm.reg.pred, valid.issues.ts))
```

# external regression

```{r}
plot(issues.ts, col='blue')
lines(commits.ts, col='green')

train.commits.d1 <- diff(train.commits.ts, lag = 1)
train.commits.d1.d7 <- diff(train.commits.d1, lag = 7)

plot(train.issues.d1.d7, col='blue')
lines(lag(train.commits.d1.d7,2), col='green')

```

```{r}
train.issues.arima.ext.m <- Arima(train.issues.ts, order=c(1,0,0), seasonal=c(1,0,0), xreg=train.commits.ts )
train.issues.arima.ext.m
```
